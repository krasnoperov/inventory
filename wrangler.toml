# ============================================================================
# BARE FRAMEWORK FOUNDATION - Main Worker Configuration
# ============================================================================
# Handles HTTP requests (API + Frontend)
# Processing worker handles queues/workflows (see wrangler.processing.toml)

account_id = "2d61278ad8b69df60cde602758926e14"
name = "inventory-stage"
main = "src/worker/unified.ts"
compatibility_date = "2025-04-01"
compatibility_flags = ["nodejs_compat"]

# Observability
[observability]
enabled = true

# Serve the React frontend
[assets]
directory = "./dist/frontend"
not_found_handling = "single-page-application"
run_worker_first = ["/api/*", "/.well-known/*"]

# Stage environment custom domain
[[routes]]
pattern = "inventory-stage.krasnoperov.me"
custom_domain = true

# D1 Database binding
[[d1_databases]]
binding = "DB"
database_name = "inventory-stage"
database_id = "fe3cb23a-2286-4a10-a21b-217fb0be999d"
migrations_dir = "db/migrations"

# KV namespace for OAuth state
[[kv_namespaces]]
binding = "OAUTH_KV"
id = "08f7fd3b25ac4cc59ad9e2975d510df3"

# Environment variables for stage
[vars]
NODE_ENV = "stage"
ENVIRONMENT = "stage"
POLAR_ENVIRONMENT = "sandbox"

# Queue Producer - sends generation jobs to processing worker
[[queues.producers]]
queue = "inventory-generation-stage"
binding = "GENERATION_QUEUE"

# Durable Objects - Space state and WebSocket
[[durable_objects.bindings]]
name = "SPACES_DO"
class_name = "SpaceDO"

[[migrations]]
tag = "v1"
new_sqlite_classes = ["SpaceDO"]

# R2 Storage for generated images
[[r2_buckets]]
binding = "IMAGES"
bucket_name = "inventory-images-stage"

# Cron Triggers - Usage sync to Polar (every 5 minutes)
[triggers]
crons = ["*/5 * * * *"]

# ====================
# PRODUCTION ENVIRONMENT
# ====================
[env.production]
name = "inventory-production"

# Production custom domains
[[env.production.routes]]
pattern = "inventory.krasnoperov.me"
custom_domain = true

[[env.production.routes]]
pattern = "www.inventory.krasnoperov.me"
custom_domain = true

# D1 Database binding - Production
[[env.production.d1_databases]]
binding = "DB"
database_name = "inventory-production"
database_id = "239df1be-1499-4d03-80bf-7341545b4547"
migrations_dir = "db/migrations"

# KV namespace for OAuth state - Production
[[env.production.kv_namespaces]]
binding = "OAUTH_KV"
id = "08f7fd3b25ac4cc59ad9e2975d510df3"

[env.production.vars]
NODE_ENV = "production"
ENVIRONMENT = "production"
POLAR_ENVIRONMENT = "production"

# Queue Producer - Production
[[env.production.queues.producers]]
queue = "inventory-generation-production"
binding = "GENERATION_QUEUE"

# Durable Objects - Production
[[env.production.durable_objects.bindings]]
name = "SPACES_DO"
class_name = "SpaceDO"

# R2 Storage for generated images - Production
[[env.production.r2_buckets]]
binding = "IMAGES"
bucket_name = "inventory-images-production"

# Cron Triggers - Usage sync to Polar (every 5 minutes)
[env.production.triggers]
crons = ["*/5 * * * *"]

# ====================
# LOCAL DEVELOPMENT
# ====================
# NOTE: Local development uses wrangler.dev.toml with unified worker
[dev]
port = 8788
local_protocol = "http"

# Secrets should be set via wrangler CLI:
# wrangler secret put GOOGLE_CLIENT_ID
# wrangler secret put GOOGLE_CLIENT_SECRET
# wrangler secret put OIDC_PRIVATE_KEY_BASE64
# wrangler secret put OIDC_KEY_ID
# wrangler secret put OIDC_ISSUER
# wrangler secret put OIDC_AUDIENCE
# wrangler secret put GOOGLE_AI_API_KEY (optional, for NanoBananaService)
# wrangler secret put ANTHROPIC_API_KEY (optional, for ClaudeService)
# wrangler secret put POLAR_ACCESS_TOKEN (optional, for Polar.sh billing)
# wrangler secret put POLAR_ORGANIZATION_ID (optional, for Polar.sh billing)
# wrangler secret put POLAR_WEBHOOK_SECRET (optional, for Polar webhook verification)
# wrangler secret put INTERNAL_API_SECRET (for internal billing sync endpoint)
