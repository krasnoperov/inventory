# ============================================================================
# Polar Billing Worker Configuration
# ============================================================================
# Dedicated worker for billing sync operations
# Handles:
# - Cron-triggered usage event sync to Polar
# - Retry of failed customer creation
# - Internal API for manual sync operations
#
# Separated from main worker so deployments don't interrupt sync

account_id = "2d61278ad8b69df60cde602758926e14"
name = "inventory-polar-stage"
main = "src/worker/polar.ts"
compatibility_date = "2025-04-01"
compatibility_flags = ["nodejs_compat"]

# Observability
[observability]
enabled = true

# Stage environment routes (for internal API access)
[[routes]]
pattern = "inventory-polar-stage.krasnoperov.me"
custom_domain = true

# D1 Database binding (same as main worker)
[[d1_databases]]
binding = "DB"
database_name = "inventory-stage"
database_id = "6619b429-e8e8-4e93-9f36-b2bdeab78a9a"
migrations_dir = "db/migrations"

# Environment variables for stage
[vars]
NODE_ENV = "stage"
ENVIRONMENT = "stage"
POLAR_ENVIRONMENT = "sandbox"

# Cron Triggers - Usage sync to Polar (every 5 minutes)
[triggers]
crons = ["*/5 * * * *"]

# ====================
# PRODUCTION ENVIRONMENT
# ====================
[env.production]
name = "inventory-polar-production"

# Production routes
[[env.production.routes]]
pattern = "inventory-polar.krasnoperov.me"
custom_domain = true

# D1 Database binding - Production
[[env.production.d1_databases]]
binding = "DB"
database_name = "inventory-production"
database_id = "16597a9f-efd7-4b61-b62f-8962da51b782"
migrations_dir = "db/migrations"

[env.production.vars]
NODE_ENV = "production"
ENVIRONMENT = "production"
POLAR_ENVIRONMENT = "production"

# Cron Triggers - Production (every 5 minutes)
[env.production.triggers]
crons = ["*/5 * * * *"]

# ====================
# LOCAL DEVELOPMENT
# ====================
[dev]
port = 8790  # Different port from main (8788) and processing (8789)
local_protocol = "http"

# Secrets should be set via wrangler CLI:
# wrangler secret put POLAR_ACCESS_TOKEN --config wrangler.polar.toml
# wrangler secret put POLAR_ORGANIZATION_ID --config wrangler.polar.toml
